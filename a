import base64
import datetime
import json
import zlib
from urllib import parse
import requests
# from selenium import webdriver
import datetime
import time
from lxml import etree


def f_token(token):
    token_decode = base64.b64decode(token.encode())
    # 二进制解压
    token_string = zlib.decompress(token_decode)
    print(token_string)


def encode_token(id):
    t=time.time()
    ts=int(round(t * 1000))
    token_dict={
        "rId":100004,
        "ver":"1.0.6",
        "ts":ts,
        "cts":ts+20,
        "brVD":[1125,2436],
        "brR":[[375,812],[375,812],24,24],
        "bI":[
            "https://i.meituan.com/awp/h5/hotel/poi/deal.html?poiId={}&cityId=1&startTime=1593964800000&endTime=1594051200000&ste=_b400200&ct_poi=224486476820479630362180640600628787555_c0_e649767168325837266_a%25e5%258c%2597%25e4%25ba%25ac%25e5%25b8%2582%25e9%259d%2599%25e6%2598%25a5%25e5%259b%25ad%25e5%25ae%25be%25e9%25a6%2586_b400200_o1_dhotelpoitagb_k1002&type=1&zlFlag=true".format(id['id']),
            ""
        ],
        "mT":[],
        "kT":[],
        "aT":[],
        "tT":[],
        "aM":"",
        "sign":"eJw1zk2KwzAMBeC7dOGlkWTLPwsvYqeBOYY7dUOgE4fEWfT2TTpUiwfiweO7/E7t9XMPKMp8JHtl0BOcJ8ZlS9922vfpHvQAQ4Sk2LDxCR0wWxtT6skmjpQsma53Q7xGJE5df+06sMZRUsDG9iCeuQUNEjWzEs95DIhGktfEWix1Ol+vgMSy1iWPuZU+txzEWutfqvvcgthaXtsHyorcP7S9lnIY962sBxKdB6WVP4oP2ihCMvlmy4P1w3LOjPIc0ATknUQJEi5vQ41HcQ=="
    }
    encode =''.join(str(token_dict).replace('\'','"').split()).encode()
    compress = zlib.compress(encode)
    # base64编码
    b_encode = base64.b64encode(compress)
    # 转为字符串
    token = str(b_encode, encoding='utf-8')
    return token

def getTime():
    d1 = datetime.datetime(1970, 1, 1)
    d2 = datetime.datetime.now()
    d3 = int((d2 - d1).total_seconds() * 1000)
    return d3

def get_uuid():
    url = 'https://i.meituan.com/ok/204?ndr'
    headers = {
        'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1',
    }
    session = requests.session()
    while 1:
        try:
            session.get(url, headers=headers)
            html_set_cookie = requests.utils.dict_from_cookiejar(session.cookies)
            cookie_data={
                "IJSESSIONID":html_set_cookie['IJSESSIONID'],
                "iuuid":html_set_cookie['iuuid'],
                "JSESSIONID":html_set_cookie['JSESSIONID'],
                "cityname":'%E5%8C%97%E4%BA%AC',
                "latlng":html_set_cookie['latlng']
            }
            return cookie_data
        except:
            pass

def get_html(token,iuuid):
    url='https://ihotel.meituan.com/group/v1/yf/list/{}?utm_medium=touch&version_name=999.9&platformid=1&start=1593964800000&end=1594051200000&type=1&lat=40.14553&lng=116.294254&gpsCityId=1&cityId=1&poi=1169302&uuid=632126ab7ef54f75aa51.1593420298.1.0.0&iuuid={}&userid=1890343900&propagateData&_token={}'.format(id['id'],cookie_data['iuuid'],token)
    headers={
        "Accept-Encoding":"gzip, deflate, br",
        "Accept-Language":"zh-CN,zh;q=0.9",
        "Connection":"keep-alive",
        "Content-Type":"application/json; charset=utf-8",
        # "cookie":'_lxsdk_cuid=172ee698f82c8-02b544d44fdd8-31607403-13c680-172ee698f82c8; IJSESSIONID={}; iuuid={}; latlng={}; ci=1; cityname=%E5%8C%97%E4%BA%AC; _lxsdk=32E2C687A4674F60628B3AE2C010273E225DAE3826EB5C1ECFECD93F6975C999; i_extend=E335684376609750617937812546654456952865_c0_e10959762285452879585_a%e9%9d%99%e6%98%a5%e5%9b%ad%e5%ae%be%e9%a6%86_b300202_o1_dhotelpoitagb_k1002Gempty__xhotelhomepage__yselect__zday; _lxsdk_s=172f9f7803a-aba-c90-301%7C%7C43'.format(cookie_data['IJSESSIONID'],cookie_data['iuuid'],cookie_data['latlng']),
        "cookie":"IJSESSIONID={}; iuuid={}; ci=1; cityname=%E5%8C%97%E4%BA%AC; _lxsdk_cuid=172ff3c3e7bc8-0f345a816c71d8-31607403-13c680-172ff3c3e7bc8; _lxsdk=4F0FB0C356569C1805577BCCD27C5B2C726AD8FBEB125CADEAA07682C30567D0; ndr=i.meituan.com; _lx_utm=utm_source%3DBaidu%26utm_medium%3Dorganic; uuid=632126ab7ef54f75aa51.1593420298.1.0.0; backurl=https://i.meituan.com; mtcdn=K; __utma=74597006.723838067.1593422538.1593422538.1593422538.1; __utmc=74597006; __utmz=74597006.1593422538.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); isid=F56CF4C479FD9EB3BD1E13BAAF808F48; oops=_uN-nu2D6Mgv1uXjWNOwghZZYVoAAAAA5goAAA0WoGA7ok_l5m1nyzubfYOC5DUjcHhKCv6UO1mSVuigSPU3xRH00S0NecZc0ULa9A; u=1890343900; logintype=fast; ci3=1; latlng=40.14553,116.294254,1593423517037; i_extend=C085021465567978133866654328195751632659_g1E133379464095117507629657943452603430263_c0_e3955758044519839236_a%e9%9d%99%e6%98%a5%e5%9b%ad%e5%ae%be%e9%a6%86_b400203_o1_dhotelpoitagb_k1002_f1169302Gimthomepagecategory120__xhotelhomepage__yselect__zday; _lxsdk_s=17302ee3d7a-c5a-dc1-8a6%7C%7C5".format(cookie_data['IJSESSIONID'],cookie_data['iuuid']),
        "Host":"ihotel.meituan.com",
        "Origin":"https://i.meituan.com",
        "Referer":"https://i.meituan.com/awp/h5/hotel/poi/deal.html?poiId=350403&cityId=1&startTime=1593273600000&endTime=1593360000000&ste=_b400203&ct_poi=300833384592564684203140620191856894758_c0_e1019606271730142832_a%25e9%2580%259f8%25e9%2585%2592%25e5%25ba%2597%25ef%25bc%2588%25e5%258c%2597%25e4%25ba%25ac%25e6%2580%2580%25e6%259f%2594%25e5%25bc%2580%25e6%2594%25be%25e8%25b7%25af%25e5%25ba%2597%25ef%25bc%2589_b400203_o1_dhotelpoitagb_k1002&type=1&zlFlag=true",
        "Sec-Fetch-Dest":"empty",
        "Sec-Fetch-Mode":"cors",
        "Sec-Fetch-Site":"same-site",
        "User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.106 Safari/537.36"
    }
    rep=requests.get(url=url,headers=headers)
    if rep.status_code==200:
        return rep.text

def get_info(data):
    data_infos=json.loads(data)['data']['result']
    if data_infos[0]['notDisplayCancelRule']==False:
        for data_info in data_infos:
            info={
                'goodsName':data_info['goodsName'],
                "averagePrice":data_info['averagePrice']
            }
            # t = time.time()
            # ts = int(round(t * 1000))
            # info_token={"rId":100004,"ver":"1.0.6","ts":ts,"cts":ts+20,"brVD":[1125,2436],"brR":[[375,812],[375,812],24,24],"bI":["https://i.meituan.com/awp/h5/hotel/poi/deal.html?poiId=1169302&cityId=1&startTime=1593532800000&endTime=1593619200000&ste=_b400200&ct_poi=224486476820479630362180640600628787555_c0_e649767168325837266_a%25e5%258c%2597%25e4%25ba%25ac%25e5%25b8%2582%25e9%259d%2599%25e6%2598%25a5%25e5%259b%25ad%25e5%25ae%25be%25e9%25a6%2586_b400200_o1_dhotelpoitagb_k1002&type=1&zlFlag=true",""],"mT":[],"kT":[],"aT":["468,1738,H2"],"tT":[],"aM":"","sign":"eJxVUV1v2yAU/S9+4KVLBNjYuZN4WFepSdUqaeIl62RpIoTablygGKtyq/33YSfr1Dfu4XxcDpGslDwu9JXwilNM8QRnE0zQCC87/xmnSNa+Xxx4IDS10j7vreLedLI6A1vl2tpoDgBTQKUxh3agxwlmBOITMIoIKm37/Z9bIzxP8JQkjMWo0SUnJJ1SSChLkDarwbT1wZ5jZIXzWrlBBpjhjCBr6mEiKcRhQ+uMFWVYO6wu+HsRVcL+Pqq+iL7qrmm+FJF1tVRhLKKL6mJ9BLmpHNW9/eF2zSXO7zkvokDzTki1OIzESYzJLAOW4SxNYpYBpHQkjQ/aeOG79n+AU6K5/nRRRLc6L/cPe8Bz2r2mq6NZkHq5ffo2f1uLu1VHdluZP+xqP6d3p3hp9Bh+9ixPNhqel5vtz/7Xzf7aP9p+fZtd3r/yD8lQUu6EbkNN4XjW/0FOvXSqPf0XRs6Y51BZAjNGZgx1rXJ1aHAGOE5iwDj6C/aTq4M="}
            # encode = ''.join(str(info_token).replace('\'', '"').split()).encode()
            # compress = zlib.compress(encode)
            # # base64编码
            # b_encode = base64.b64encode(compress)
            # # 转为字符串
            # token = str(b_encode, encoding='utf-8')
            # url='https://ihotel.meituan.com/group/v1/yf/productDetail?_token={}&uuid=632126ab7ef54f75aa51.1593420298.1.0.0&iuuid={}&userid=1890343900&utm_medium=touch&version_name=999.9&platformid=1'.format(token,cookie_data['iuuid'])
            # datainfo={
            #     "checkInDate":"2020-07-01",
            #     "checkOutDate":"2020-07-02",
            #     "lat":"39.909948",
            #     "lng":"116.47318",
            #     "userid":"1890343900",
            #     "gpsCityId":"1",
            #     "cityId":"1",
            #     "goodsId":data_info['goodsRoomModels'][0]['goodsId'],
            #     "goodsType":1,
            #     "partnerId":data_info['goodsRoomModels'][0]['partnerId'],
            #     "poiId":data_info['goodsRoomModels'][0]['poiId'],
            #     "requestType":0,
            #     "noPersistent":0,
            #     "roomId":data_info['goodsRoomModels'][0]['roomId'],
            #     "clientType":"touch",
            #     "clientVersion":"999.9",
            #     "propagateData":"{\"hap_key\":null,\"price\":\"+h+Rk9cShr2nypUrWlB0TQ==\",\"traceId\":\"8896148300185526626\",\"goodsStatus\":null,\"realGoodsStatus\":\"lIUtdvHM5mRi2ZKA4H37H0bpCJU6pdMcN8p0wH1HzgM=\",\"conId\":null,\"gs\":\"14VmSKUDV3qSoIOYNhKyHQ==\",\"contentTransparent\":null}"
            # }
            # headers={
            #     "Accept-Encoding": "gzip, deflate, br",
            #     "Accept-Language": "zh-CN,zh;q=0.9",
            #     "Connection":"keep-alive",
            #     "Content-Length":"580",
            #     "Content-Type":"application/json; charset=UTF-8",
            #     "Cookie":"IJSESSIONID=gfacp96sy7t01gt51v2dfjcvt; iuuid=4F0FB0C356569C1805577BCCD27C5B2C726AD8FBEB125CADEAA07682C30567D0; ci=1; cityname=%E5%8C%97%E4%BA%AC; _lxsdk_cuid=172ff3c3e7bc8-0f345a816c71d8-31607403-13c680-172ff3c3e7bc8; _lxsdk=4F0FB0C356569C1805577BCCD27C5B2C726AD8FBEB125CADEAA07682C30567D0; ndr=i.meituan.com; _lx_utm=utm_source%3DBaidu%26utm_medium%3Dorganic; uuid=632126ab7ef54f75aa51.1593420298.1.0.0; backurl=https://i.meituan.com; mtcdn=K; __utma=74597006.723838067.1593422538.1593422538.1593422538.1; __utmc=74597006; __utmz=74597006.1593422538.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); isid=F56CF4C479FD9EB3BD1E13BAAF808F48; oops=_uN-nu2D6Mgv1uXjWNOwghZZYVoAAAAA5goAAA0WoGA7ok_l5m1nyzubfYOC5DUjcHhKCv6UO1mSVuigSPU3xRH00S0NecZc0ULa9A; u=1890343900; logintype=fast; ci3=1; latlng=40.14553,116.294254,1593423517037; i_extend=C085021465567978133866654328195751632659_g1E133379464095117507629657943452603430263_c0_e3955758044519839236_a%e9%9d%99%e6%98%a5%e5%9b%ad%e5%ae%be%e9%a6%86_b400203_o1_dhotelpoitagb_k1002_f1169302Gimthomepagecategory120__xhotelhomepage__yselect__zday; _lxsdk_s=17302ee3d7a-c5a-dc1-8a6%7C%7C7",
            #     "Host":"ihotel.meituan.com",
            #     "Origin":"https://i.meituan.com",
            #     "User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1"
            # }
            # rep=requests.post(url,data=json.dumps(datainfo),headers=headers)
            # sellPrice=json.loads(rep.text)['data']['sellPrice']
            print(info)

    else:
        for data_info in data_infos:
            info = {
                'goodsName': data_info['goodsName'],
                "averagePrice": data_info['averagePrice']
            }
            print(info)
        print('当前价格为错误')

if __name__ == '__main__':
    # token ="eJxNUm3PqjgQ/S8k6xeM0AKlPInZiOgjiqjgC3pzYypUQUFeBEVu9r9v2V13tyEzc+acaWaY/uIKM+C+gMiO3OWetOC+ONATe4jrcuWDMYomyRhKItQk1OX8/+WwCBDGXe5UbA3u6wcAUOlCWUI/25TDMj8kVeliAH92/4ugzL5WYTIBF5Zl9vgShKiX0KisyL3np4lAXpkQKkKYljQWsjQSAkriXlgm8e8MmUEfAKSxjjp+VL5b2HmUpCjXUUL7bW+KxHprT4feg3+zCGjw7+yjpP3jSRZFhjt+eWSX9iGUZYxkFWEoyqqGJFFCEGARySISRQSxilVFUY6+eKRI1lSksuElqGBJhQgdyW9QoQoz2GdGU1soM3NqCeJ/2BNuJbCFWqsLWtNGFLVRyxLlI9ZOLQw+kND2AvqpJW0FRp85jik4Bn/9MTZNSS6n440tFXbKd8bG7zTxOCaXfllUlC2WYwtI1mwBzN/+8aT1nIxwF6gS7k5gKyo/5Jw9C1b4iC53FtFpvd1swRO+BxvB1Xh5trV0+7qvDra8G9PMDTY5oWaMoJOZ6Zqc4vfle1a+c0GS9u65AMa5kr3aN7LvR2y8Km3qvaLYnuOVcx+JzWo4xKpQJ3fXJrxX17JpuEC8qs+CWjSwTDQAzxiWWWpc9PVqtqlDiVzqV5zoC3M9N1NzlkiqcNBOZlMv8XR1u853qehu7tMpcN1haN0MUrxOa/A6KNeD6TW7Itb17Bpeh3qBklE0851wxVfz8W67X6BXxU8ezta3+GWe85Gl5kWS8OPpGJRbJ7RmMwslU023kmxi7zSBjmHjegu1uT3Tm9GsbxFYmM3I3TdTa7DYyW5t77O9nk1YXyuB0MW3qt35wQbNFOHuOI7lI0vwlxTrDSxgkiP7cJvkyvmcwjOorApsJ0FcHZZ8nS9RIGVSmGl6yGtRvbTDnMbKs2wE1WvOKllqGX8+lIFUCG8Dx6tNhUanm23L3nUniOPF03Pz5Vn0nAfaK0A/DK729+FSg8KbAjIZfC9GSvQyrmgokHUuz/vcH38CbWM7VQ=="
    # f_token(token)
    # i=1
    # while True:
    #     print(i)
        ids=[
            {"name":"速8酒店常州环球恐龙城万达广场店","id":"912881"},
            {"name":"速8酒店北京西单大悦城店(内宾)","id":"1496223"},
            {"name":"如家（北京西单大悦城店）","id":"2451514"},
            {"name": "北京市静春园宾馆", "id": "1169302"},
        ]

        for id in ids:
            print('抓取--{}'.format(id['name']))
            token=encode_token(id)
            cookie_data=get_uuid()
            data=get_html(token,cookie_data)
            print(cookie_data['iuuid'])
            get_info(data)
            time.sleep(3)
        # i+=1




