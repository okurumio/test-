import base64
import datetime
import json
import zlib
from urllib import parse
import requests
# from selenium import webdriver
import datetime
import time
from lxml import etree
from pymongo import *
import re


# 隧道服务器
tunnel_host = "tps136.kdlapi.com"
tunnel_port = "15818"
# 隧道id和密码
tid = "t16948189012577"
password = "jj5bkto1"
proxies = {
    "http": "http://%s:%s@%s:%s/" % (tid, password, tunnel_host, tunnel_port),
    "https": "http://%s:%s@%s:%s/" % (tid, password, tunnel_host, tunnel_port)
}


def f_token(token):
    token_decode = base64.b64decode(token.encode())
    # 二进制解压
    token_string = zlib.decompress(token_decode)
    print(token_string)


def encode_token(id):
    t=time.time()
    ts=int(round(t * 1000))
    token_dict={
    "rId":100004,
    "ver":"1.0.6",
    "ts":ts,
    "cts":ts+20,
    "brVD":[
        1242,
        2208
    ],
    "brR":[
        [
            414,
            736
        ],
        [
            414,
            736
        ],
        24,
        24
    ],
    "bI":[
        "https://i.meituan.com/awp/h5/hotel/poi/deal.html?poiId={}&cityId=1&startTime=1593273600000&endTime=1593360000000&ste=_b400203&ct_poi=300833384592564684203140620191856894758_c0_e1019606271730142832_a%25e9%2580%259f8%25e9%2585%2592%25e5%25ba%2597%25ef%25bc%2588%25e5%258c%2597%25e4%25ba%25ac%25e6%2580%2580%25e6%259f%2594%25e5%25bc%2580%25e6%2594%25be%25e8%25b7%25af%25e5%25ba%2597%25ef%25bc%2589_b400203_o1_dhotelpoitagb_k1002&type=1&zlFlag=true".format(id),
        ""
    ],
    "mT":[

    ],
    "kT":[

    ],
    "aT":[

    ],
    "tT":[

    ],
    "aM":"",
    "sign":"eJw1zrGOgzAQBNB/SeHSWtvrtbdwgQ1I9xk+4BBSDiMwRf4+XJKbYprRSO82LPXxNQYlpvVqy8YQvCPm7Uj/63KeyxhSwtbpPqbI1DJi6ojbBkzHhISNb9B73ZGixATKp9hgtKij9dD3kVtxzzUgSIVOE4v7OgelSGomyyS2sgRjAcGIbS9bnnOd2lxzEHspv6mcaw3iqHmvL6h2H6qoj226jOcx7RdSvKjssh8GGg3QgOB/vkeN8u+mjPOgpZIg4fYEuDFFyA=="
}
    # token_dicts='{"rId":100004,"ver":"1.0.6","ts":1593316226071,"cts":1593316927028,"brVD":[1242,2208],"brR":[[414,736],[414,736],24,24],"bI":["https://i.meituan.com/awp/h5/hotel/poi/deal.html?poiId=350403&cityId=1&startTime=1593273600000&endTime=1593360000000&ste=_b400203&ct_poi=300833384592564684203140620191856894758_c0_e1019606271730142832_a%25e9%2580%259f8%25e9%2585%2592%25e5%25ba%2597%25ef%25bc%2588%25e5%258c%2597%25e4%25ba%25ac%25e6%2580%2580%25e6%259f%2594%25e5%25bc%2580%25e6%2594%25be%25e8%25b7%25af%25e5%25ba%2597%25ef%25bc%2589_b400203_o1_dhotelpoitagb_k1002&type=1&zlFlag=true",""],"mT":[],"kT":[],"aT":[],"tT":[],"aM":"","sign":"eJw1zrGOgzAQBNB/SeHSWtvrtbdwgQ1I9xk+4BBSDiMwRf4+XJKbYprRSO82LPXxNQYlpvVqy8YQvCPm7Uj/63KeyxhSwtbpPqbI1DJi6ojbBkzHhISNb9B73ZGixATKp9hgtKij9dD3kVtxzzUgSIVOE4v7OgelSGomyyS2sgRjAcGIbS9bnnOd2lxzEHspv6mcaw3iqHmvL6h2H6qoj226jOcx7RdSvKjssh8GGg3QgOB/vkeN8u+mjPOgpZIg4fYEuDFFyA=="}'
    # 二进制编码
    encode =''.join(str(token_dict).replace('\'','"').split()).encode()
    compress = zlib.compress(encode)
    # base64编码
    b_encode = base64.b64encode(compress)
    # 转为字符串
    token = str(b_encode, encoding='utf-8')
    return token


def getTime():
    d1 = datetime.datetime(1970, 1, 1)
    d2 = datetime.datetime.now()
    d3 = int((d2 - d1).total_seconds() * 1000)
    return d3


def get_uuid():
    url = 'https://bj.meituan.com/'
    headers = {
        'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1',
    }
    session = requests.session()
    while 1:
        try:
            session.get(url, headers=headers, timeout=2)
            html_set_cookie = requests.utils.dict_from_cookiejar(session.cookies)
            cookie_data={
                "IJSESSIONID":html_set_cookie['IJSESSIONID'],
                "iuuid":html_set_cookie['iuuid'],
                "JSESSIONID":html_set_cookie['JSESSIONID'],
                "cityname":'%E5%8C%97%E4%BA%AC',
                "latlng":html_set_cookie['latlng']
            }
            return cookie_data
        except:
            pass


def get_html(token,iuuid):
    url='https://ihotel.meituan.com/group/v1/yf/list/{}?utm_medium=touch&version_name=999.9&platformid=1&start=1593273600000&end=1593360000000&type=1&lat=40.147269&lng=116.296596&gpsCityId=1&cityId=1&poi=350403&uuid=97a8cc6d306c408fbd24.1593137802.1.0.0&iuuid={}&propagateData&_token={}'.format(hotel_id ,cookie_data['iuuid'],token)
    headers={
        "Accept-Encoding":"gzip, deflate, br",
        "Accept-Language":"zh-CN,zh;q=0.9",
        "Connection":"keep-alive",
        "Content-Type":"application/json; charset=utf-8",
        # "Cookie":"IJSESSIONID={}; iuuid={}; latlng={}; ci=1; cityname={}; _lxsdk_cuid=172ee698f82c8-02b544d44fdd8-31607403-13c680-172ee698f82c8; _lxsdk=CC4D72FBCB96D944CE69DA03E96464A8A4882E616C96018CBA4B542B580FFB9D; uuid=97a8cc6d306c408fbd24.1593137802.1.0.0; ndr=i.meituan.com; i_extend=C085021465567978133866654328195751632659_g1E300833384592564684203140620191856894758_c0_e7294387844067557360_a%e9%80%9f8%e9%85%92%e5%ba%97%ef%bc%88%e5%8c%97%e4%ba%ac%e6%80%80%e6%9f%94%e5%bc%80%e6%94%be%e8%b7%af%e5%ba%97%ef%bc%89_o1_dhotelpoitagb_k1002_b400203_f350403Gempty; _lxsdk_s=172f9410d28-8fe-d72-8fe%7C%7C6".format(cookie_data['IJSESSIONID'],cookie_data['iuuid'],cookie_data['latlng'],cookie_data['cityname']),
        "cookie":'IJSESSIONID=1x5l4oidvtt0wcgymcazoqjy4; iuuid=CC4D72FBCB96D944CE69DA03E96464A8A4882E616C96018CBA4B542B580FFB9D; latlng=40.147269%2C116.296596%2C1593135988770; ci=1; cityname=%E5%8C%97%E4%BA%AC; _lxsdk_cuid=172ee698f82c8-02b544d44fdd8-31607403-13c680-172ee698f82c8; _lxsdk=CC4D72FBCB96D944CE69DA03E96464A8A4882E616C96018CBA4B542B580FFB9D; uuid=97a8cc6d306c408fbd24.1593137802.1.0.0; ndr=i.meituan.com; i_extend=C085021465567978133866654328195751632659_g1E300833384592564684203140620191856894758_c0_e13934344969857807981_a%e5%a6%82%e5%ae%b6%e9%85%92%e5%ba%97%ef%bc%88%e5%8c%97%e4%ba%ac%e8%a5%bf%e5%8d%95%e5%a4%a7%e6%82%a6%e5%9f%8e%e5%ba%97%ef%bc%89_o1_dhotelpoitagb_k1002_b400202_f350403Gempty__xhotelhomepage__yselect__zday; _lxsdk_s=172f9410d28-8fe-d72-8fe%7C%7C26',
        "Host":"ihotel.meituan.com",
        "Origin":"https://i.meituan.com",
        "Referer":"https://i.meituan.com/awp/h5/hotel/poi/deal.html?poiId=350403&cityId=1&startTime=1593273600000&endTime=1593360000000&ste=_b400203&ct_poi=300833384592564684203140620191856894758_c0_e1019606271730142832_a%25e9%2580%259f8%25e9%2585%2592%25e5%25ba%2597%25ef%25bc%2588%25e5%258c%2597%25e4%25ba%25ac%25e6%2580%2580%25e6%259f%2594%25e5%25bc%2580%25e6%2594%25be%25e8%25b7%25af%25e5%25ba%2597%25ef%25bc%2589_b400203_o1_dhotelpoitagb_k1002&type=1&zlFlag=true",
        "Sec-Fetch-Dest":"empty",
        "Sec-Fetch-Mode":"cors",
        "Sec-Fetch-Site":"same-site",
        "User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1"
    }
    rep=requests.get(url=url, headers=headers)
    print(rep.text)
    if rep.status_code == 200:
        return rep.text


def get_info(data):
    data_infos=json.loads(data)['data']['result']
    for data_info in data_infos:
        info={
            'goodsName':data_info['goodsName'],
            "averagePrice":data_info['averagePrice']
        }
        print(info)


client = MongoClient('localhost', 27017)
database = client['su8']

if __name__ == '__main__':
    # token ="eJx9U2tv2jAU/S+Rxpci4lcSGwlNMFpIaQmQlpVWU5SHyQMCITHhMe2/z0aFbV8WRb73nHt04lxf/9RKO9LaEMiHNLWal1pbgy3QMrWmJipZMRjG0ETIBBZsauFfHEMWQLSpBeW8r7U/ICKoiRCgPxQ1k8wHgaRpYfNH80+GiHyVwpYCLRGiqNq6nrZynoq9v2mF21z3D4WeGHqyFXytF9tUj7i/biUiX3+VyI462AAE4EaYipNEsFEJvxQvac47amtIfkj9D2jwTXRjPznJVoJ3vIAAgJSH8KRnBwNAMcaUGAwZJjEpkUVIgIkAZJAaJmXEMqgXAo9DSZmyYkELA0gQxcjzvyCDM7lQIBe2pDdsKIwUVFmghMxScKlgqCT0WqXhrUquYl9x3LxaX5YLZMqAkZtz+G/1YsAVVPaBMvWX/90GuzbF20IvunRftkb4ceCt5ICghjgVspeN8/ph7ccdUe65HBJNHmb+Ig9TxtVn9D+juOJnOVVSW6XxRmb88QDP5cCJz91pb9zTXT50v4u6FEF0iKfQZsfVHen13H76fJgtyd3b4yhYFOXMdSh6mrwdx9PFuqjnuxNdTOtvk9x6zXQTj/jpmLgHERSTXWDD/mNqbrOgtzoPE9sdB6xn4fdBeuy+jAqWxGKUZizq49VcHM/n19i15849qS0n5mt3sM1PJxdV8SzrhgM7cFmw2TgRWh/P98OqqM089A843Q3z+slM0NDcbTN5QzInPFqzyK1HWVUldDCI8TR2enq94mO6v8uziRMX73ZMlov7ff/h4dTtdLRfvwGBuv7A"
    # f_token(token)
    ids=[
        {"name":"速8酒店常州环球恐龙城万达广场店","id":"912881"},
        {"name":"速8酒店北京西单大悦城店(内宾)","id":"1496223"},
        {"name":"如家（北京西单大悦城店）","id":"2451514"},
    ]
    urlList = [url for url in database.meituan_url.find()]
    for i in urlList:
        ordUrl = re.sub(r'\?(.*)?$', '', i['hotelUrl'])
        hotel_id = ''.join(re.findall(r"\d+", ordUrl))
        print('抓取--{}'.format(i['hotel_name']))
        print(ordUrl)
        token=encode_token(hotel_id)
        cookie_data=get_uuid()
        data=get_html(token,cookie_data)
        get_info(data)


