import base64
import datetime
import json
import random
import re
import zlib
from urllib import parse

import pymongo
import redis
import requests
# from selenium import webdriver
import datetime
import time
from lxml import etree
from pymongo import *

pool1 = redis.ConnectionPool(host='114.55.84.165', port=6379, db=0, password="FNldn.dgdj,gDN,34md")
conn1 = redis.StrictRedis(connection_pool=pool1)
# 隧道服务器
tunnel_host = "tps136.kdlapi.com"
tunnel_port = "15818"
# 隧道id和密码
tid = "t16948189012577"
password = "jj5bkto1"
proxies1 = { "http": "http://%s:%s@%s:%s/" % (tid, password, tunnel_host, tunnel_port),
    # "https": "http://%s:%s@%s:%s/" % (self.tid, self.password, self.tunnel_host, self.tunnel_port)
}
def f_token(token):
    token_decode = base64.b64decode(token.encode())
    # 二进制解压
    token_string = zlib.decompress(token_decode)
    print(token_string)


def encode_token(hotel_id):
    t=time.time()
    ts=int(round(t * 1000))
    token_dict={
        "rId":100004,
        "ver":"1.0.6",
        "ts":ts,
        "cts":ts+20,
        "brVD":[1125,2436],
        "brR":[[375,812],[375,812],24,24],
        "bI":[
            "https://i.meituan.com/awp/h5/hotel/poi/deal.html?poiId={}&cityId=1&startTime=1593964800000&endTime=1594051200000&ste=_b400200&ct_poi=224486476820479630362180640600628787555_c0_e649767168325837266_a%25e5%258c%2597%25e4%25ba%25ac%25e5%25b8%2582%25e9%259d%2599%25e6%2598%25a5%25e5%259b%25ad%25e5%25ae%25be%25e9%25a6%2586_b400200_o1_dhotelpoitagb_k1002&type=1&zlFlag=true".format(hotel_id),
            ""
        ],
        "mT":[],
        "kT":[],
        "aT":[],
        "tT":[],
        "aM":"",
        "sign":"eJw1zk2KwzAMBeC7dOGlkWTLPwsvYqeBOYY7dUOgE4fEWfT2TTpUiwfiweO7/E7t9XMPKMp8JHtl0BOcJ8ZlS9922vfpHvQAQ4Sk2LDxCR0wWxtT6skmjpQsma53Q7xGJE5df+06sMZRUsDG9iCeuQUNEjWzEs95DIhGktfEWix1Ol+vgMSy1iWPuZU+txzEWutfqvvcgthaXtsHyorcP7S9lnIY962sBxKdB6WVP4oP2ihCMvlmy4P1w3LOjPIc0ATknUQJEi5vQ41HcQ=="
    }
    encode =''.join(str(token_dict).replace('\'','"').split()).encode()
    compress = zlib.compress(encode)
    # base64编码
    b_encode = base64.b64encode(compress)
    # 转为字符串
    token = str(b_encode, encoding='utf-8')
    return token


def getTime():
    d1 = datetime.datetime(1970, 1, 1)
    d2 = datetime.datetime.now()
    d3 = int((d2 - d1).total_seconds() * 1000)
    return d3


def get_uuid():
    url = 'https://i.meituan.com/ok/204?ndr'
    ua=[
        "Mozilla/5.0 (Linux; Android 7.1.1; OPPO R11t Build/NMF26X; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0",
        "Mozilla/5.0 (Linux; Android 8.1.0; vivo Y85A Build/OPM1.171019.011; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0",
        "Mozilla/5.0 (Linux; Android 8.0.0; VIE-AL10 Build/HUAWEIVIE-AL10; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0",
        "Mozilla/5.0 (Linux; Android 9; ELE-AL00 Build/HUAWEIELE-AL00; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0"
    ]
    user_agent=random.choice(ua)
    headers = {
        'User-Agent': user_agent,
    }
    session = requests.session()
    i=1
    while True:
        try:
            proxy = random_get_proxy()
            proxies = {
                "https": "https://{0}".format(proxy),
                "http": "http://{0}".format(proxy),
            }
            session.get(url, headers=headers,proxies=proxies,timeout=2)
            html_set_cookie = requests.utils.dict_from_cookiejar(session.cookies)
            cookie_data={
                "IJSESSIONID":html_set_cookie['IJSESSIONID'],
                "iuuid":html_set_cookie['iuuid'],
                "JSESSIONID":html_set_cookie['JSESSIONID'],
                "cityname":'%E5%8C%97%E4%BA%AC',
                "latlng":html_set_cookie['latlng'],
                "ua":"{}".format(user_agent)
            }
            return cookie_data,proxies
        except Exception as f:
            print(f)
            i+=1


def random_get_proxy():
    redis_key = "proxy:new_ip_list"
    proxy = conn1.srandmember(redis_key)
    proxy = proxy.decode('utf-8')
    return proxy


def get_html(token, cookie_data, proxies, hotel_id, start_timestamp, end_timestamp):
    url='https://ihotel.meituan.com/group/v1/yf/list/{}?utm_medium=touch&version_name=999.9&platformid=1&start={}&end={}&type=1&lat=40.14553&lng=116.294254&gpsCityId=1&cityId=1&poi=1169302&uuid=632126ab7ef54f75aa51.1593420298.1.0.0&iuuid={}&userid=1890343900&propagateData&_token={}'.format(hotel_id,start_timestamp,end_timestamp,cookie_data['iuuid'],token)
    headers={
        "Accept-Encoding":"gzip, deflate, br",
        "Accept-Language":"zh-CN,zh;q=0.9",
        "Connection":"keep-alive",
        "Content-Type":"application/json; charset=utf-8",
        # "cookie":'_lxsdk_cuid=172ee698f82c8-02b544d44fdd8-31607403-13c680-172ee698f82c8; IJSESSIONID={}; iuuid={}; latlng={}; ci=1; cityname=%E5%8C%97%E4%BA%AC; _lxsdk=32E2C687A4674F60628B3AE2C010273E225DAE3826EB5C1ECFECD93F6975C999; i_extend=E335684376609750617937812546654456952865_c0_e10959762285452879585_a%e9%9d%99%e6%98%a5%e5%9b%ad%e5%ae%be%e9%a6%86_b300202_o1_dhotelpoitagb_k1002Gempty__xhotelhomepage__yselect__zday; _lxsdk_s=172f9f7803a-aba-c90-301%7C%7C43'.format(cookie_data['IJSESSIONID'],cookie_data['iuuid'],cookie_data['latlng']),
        "cookie":"IJSESSIONID={}; iuuid={}; ci=1; cityname=%E5%8C%97%E4%BA%AC; _lxsdk_cuid=172ff3c3e7bc8-0f345a816c71d8-31607403-13c680-172ff3c3e7bc8; _lxsdk=4F0FB0C356569C1805577BCCD27C5B2C726AD8FBEB125CADEAA07682C30567D0; ndr=i.meituan.com; _lx_utm=utm_source%3DBaidu%26utm_medium%3Dorganic; uuid=632126ab7ef54f75aa51.1593420298.1.0.0; backurl=https://i.meituan.com; mtcdn=K; __utma=74597006.723838067.1593422538.1593422538.1593422538.1; __utmc=74597006; __utmz=74597006.1593422538.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); isid=F56CF4C479FD9EB3BD1E13BAAF808F48; oops=_uN-nu2D6Mgv1uXjWNOwghZZYVoAAAAA5goAAA0WoGA7ok_l5m1nyzubfYOC5DUjcHhKCv6UO1mSVuigSPU3xRH00S0NecZc0ULa9A; u=1890343900; logintype=fast; ci3=1; latlng=40.14553,116.294254,1593423517037; i_extend=C085021465567978133866654328195751632659_g1E133379464095117507629657943452603430263_c0_e3955758044519839236_a%e9%9d%99%e6%98%a5%e5%9b%ad%e5%ae%be%e9%a6%86_b400203_o1_dhotelpoitagb_k1002_f1169302Gimthomepagecategory120__xhotelhomepage__yselect__zday; _lxsdk_s=17302ee3d7a-c5a-dc1-8a6%7C%7C5".format(cookie_data['IJSESSIONID'],cookie_data['iuuid']),
        "Host":"ihotel.meituan.com",
        "Origin":"https://i.meituan.com",
        "Referer":"https://i.meituan.com/awp/h5/hotel/poi/deal.html?poiId=350403&cityId=1&startTime={}&endTime={}&ste=_b400203&ct_poi=300833384592564684203140620191856894758_c0_e1019606271730142832_a%25e9%2580%259f8%25e9%2585%2592%25e5%25ba%2597%25ef%25bc%2588%25e5%258c%2597%25e4%25ba%25ac%25e6%2580%2580%25e6%259f%2594%25e5%25bc%2580%25e6%2594%25be%25e8%25b7%25af%25e5%25ba%2597%25ef%25bc%2589_b400203_o1_dhotelpoitagb_k1002&type=1&zlFlag=true".format(start_timestamp,end_timestamp),
        "Sec-Fetch-Dest":"empty",
        "Sec-Fetch-Mode":"cors",
        "Sec-Fetch-Site":"same-site",
        "User-Agent":'{}'.format(cookie_data['ua'])
    }
    i = 0
    while i < 5:
        try:
            rep=requests.get(url=url,headers=headers,proxies=proxies1, timeout=3)
            break
        except:
            pass
    if rep.status_code==200:
        return rep.text


def get_info(data):
    try:
        data_infos=json.loads(data)['data']['result']
        price_list = {}
        for data_info in data_infos:
            info={
                'goodsName':data_info['goodsName'],
                "averagePrice":data_info['averagePrice'],
                "goodsId":data_info['goodsId']
            }
            price_list[info['goodsId']] = info['averagePrice']
        return price_list
    except:
        return []


def get_timeStamp(timeold):
    # 先转换为时间数组
    timeArray = time.strptime(timeold.split()[0]+' '+'00:00:00', "%Y-%m-%d %H:%M:%S")
    # 转换为时间戳
    timeStamp = int(time.mktime(timeArray))*1000
    return timeStamp


if __name__ == '__main__':
    client = pymongo.MongoClient("mongodb://120.27.195.31:40010/")
    database = client['v3data']
    start_time=datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    start_timestamp=get_timeStamp(start_time)
    end_time=(datetime.datetime.now() + datetime.timedelta(days=+1)).strftime("%Y-%m-%d %H:%M:%S")
    end_timestamp=get_timeStamp(end_time)
    urlList = [url for url in database.meituan_url.find()]
    x=1
    for i in urlList[0:]:
        print('{}--{}'.format(start_time,end_time))
        ordUrl = re.sub(r'\?(.*)?$', '', i['hotelUrl'])
        hotel_id = ''.join(re.findall(r"\d+", ordUrl))
        print(x)
        print('抓取--{}'.format(i['hotel_name']))
        token=encode_token(hotel_id)
        cookie_data,proxies=get_uuid()
        data=get_html(token,cookie_data, proxies,hotel_id, start_timestamp, end_timestamp)
        print(cookie_data['iuuid'])
        get_info(data)
        time.sleep(3)
        x+=1
